# æ™ºèƒ½æ¯”ä»·å°ç¨‹åº - ç”Ÿäº§çº§ç³»ç»Ÿå¼€å‘è®°å½•

**æ—¶é—´ï¼š** 2025-09-11  
**æ–‡ä»¶ç¼–å·ï¼š** DO_20250911_001  
**é¡¹ç›®ï¼š** æ™ºèƒ½æ¯”ä»·å¾®ä¿¡å°ç¨‹åºç”Ÿäº§çº§å¼€å‘  

## å¼€å‘èƒŒæ™¯

### ç”¨æˆ·éœ€æ±‚
**ç”¨æˆ·é—®é¢˜ï¼š** "å°†ç°æœ‰é¡¹ç›®ç»§ç»­æœç€å¯å®é™…å‘å¸ƒä¾›ç”¨æˆ·å®é™…ä½¿ç”¨äº§å“çš„ç›®æ ‡ç»§ç»­å®Œå–„ï¼Œç»§ç»­"

**éœ€æ±‚åˆ†æï¼š** ç”¨æˆ·å¸Œæœ›å°†å½“å‰çš„æ¼”ç¤ºç‰ˆæœ¬æ™ºèƒ½æ¯”ä»·å°ç¨‹åºå‡çº§ä¸ºç”Ÿäº§çº§äº§å“ï¼Œèƒ½å¤Ÿå®é™…å‘å¸ƒä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œéœ€è¦ä»æ¨¡æ‹Ÿæ•°æ®è½¬å‘çœŸå®æ•°æ®ï¼Œå»ºç«‹å®Œæ•´çš„åç«¯æœåŠ¡ä½“ç³»ã€‚

### æŠ€æœ¯ç›®æ ‡
- ä»æ¨¡æ‹Ÿæ•°æ®è½¬æ¢ä¸ºçœŸå®ç”µå•†æ•°æ®æŠ“å–
- å»ºç«‹å®Œæ•´çš„åç«¯APIæœåŠ¡æ¶æ„  
- å®ç°ç”Ÿäº§çº§çš„æ•°æ®å­˜å‚¨å’Œç¼“å­˜ç³»ç»Ÿ
- å»ºç«‹ç›‘æ§ã€æ—¥å¿—å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- æä¾›å®Œæ•´çš„éƒ¨ç½²å’Œè¿ç»´æ–¹æ¡ˆ

## å¼€å‘å®æ–½è®°å½•

### é˜¶æ®µ1ï¼šä»»åŠ¡è§„åˆ’å’Œæ¶æ„è®¾è®¡

**æ‰§è¡Œå†…å®¹ï¼š**
- æ›´æ–°Todoåˆ—è¡¨ï¼Œåˆ¶å®šç”Ÿäº§çº§å¼€å‘ä»»åŠ¡
- åˆ†æä»æ¼”ç¤ºç‰ˆåˆ°ç”Ÿäº§ç‰ˆçš„æŠ€æœ¯å·®è·
- è®¾è®¡åç«¯æœåŠ¡æ•´ä½“æ¶æ„

**å…³é”®å†³ç­–ï¼š**
- é€‰æ‹©Node.js + Expressä½œä¸ºåç«¯æ¡†æ¶
- é‡‡ç”¨MySQL + Redisçš„æ•°æ®å­˜å‚¨æ–¹æ¡ˆ
- è®¾è®¡RESTful APIæ¥å£è§„èŒƒ
- è§„åˆ’å¾®æœåŠ¡åŒ–çš„çˆ¬è™«ç³»ç»Ÿ

**ä»»åŠ¡æ¸…å•ï¼š**
```
1. [in_progress] æ­å»ºåç«¯çˆ¬è™«å’ŒAPIæœåŠ¡
2. [pending] ç”³è¯·åŸŸåã€SSLè¯ä¹¦å’ŒæœåŠ¡å™¨é…ç½®  
3. [pending] å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å¼•å¯¼
4. [pending] è®¾è®¡æ•°æ®åº“å’Œç¼“å­˜ç³»ç»Ÿ
5. [pending] å¼€å‘çœŸå®çš„ç”µå•†å¹³å°æ•°æ®æŠ“å–
6. [pending] ä»·æ ¼å†å²ã€æ”¶è—ã€æé†’ç­‰åŠŸèƒ½
7. [pending] ç”¨æˆ·å¢é•¿å’Œäº§å“æ¨å¹¿ç­–ç•¥
```

### é˜¶æ®µ2ï¼šåç«¯APIæœåŠ¡æ¡†æ¶æ­å»º

**æŠ€æœ¯æ ˆé€‰æ‹©ï¼š**
```javascript
// æ ¸å¿ƒä¾èµ–
"express": "^4.18.2",      // Webæ¡†æ¶
"cors": "^2.8.5",          // è·¨åŸŸæ”¯æŒ  
"helmet": "^7.1.0",        // å®‰å…¨ä¸­é—´ä»¶
"morgan": "^1.10.0",       // æ—¥å¿—ä¸­é—´ä»¶
"axios": "^1.6.0",         // HTTPå®¢æˆ·ç«¯
"cheerio": "^1.0.0-rc.12", // HTMLè§£æ
"redis": "^4.6.10",        // ç¼“å­˜
"mysql2": "^3.6.5",        // æ•°æ®åº“
"winston": "^3.11.0"       // æ—¥å¿—ç³»ç»Ÿ
```

**é¡¹ç›®ç»“æ„è®¾è®¡ï¼š**
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.js           # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ routes/            # è·¯ç”±å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ product.js     # å•†å“ç›¸å…³è·¯ç”±
â”‚   â”‚   â””â”€â”€ health.js      # å¥åº·æ£€æŸ¥è·¯ç”±
â”‚   â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â””â”€â”€ productService.js
â”‚   â”œâ”€â”€ scrapers/          # çˆ¬è™«ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ index.js       # çˆ¬è™«ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ base.js        # çˆ¬è™«åŸºç±»
â”‚   â”‚   â”œâ”€â”€ taobao.js      # æ·˜å®çˆ¬è™«
â”‚   â”‚   â”œâ”€â”€ tmall.js       # å¤©çŒ«çˆ¬è™«
â”‚   â”‚   â”œâ”€â”€ jd.js          # äº¬ä¸œçˆ¬è™«
â”‚   â”‚   â””â”€â”€ pinduoduo.js   # æ‹¼å¤šå¤šçˆ¬è™«
â”‚   â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ validation.js  # è¾“å…¥éªŒè¯
â”‚   â”‚   â””â”€â”€ errorHandler.js # é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ logger.js     # æ—¥å¿—å·¥å…·
â”‚       â”œâ”€â”€ cache.js      # ç¼“å­˜ç®¡ç†
â”‚       â”œâ”€â”€ database.js   # æ•°æ®åº“ç®¡ç†
â”‚       â””â”€â”€ urlParser.js  # URLè§£æ
â”œâ”€â”€ tests/                # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ scripts/              # è„šæœ¬æ–‡ä»¶
â”œâ”€â”€ logs/                 # æ—¥å¿—ç›®å½•
â””â”€â”€ package.json          # é¡¹ç›®é…ç½®
```

**æ ¸å¿ƒæœåŠ¡å™¨å®ç°ï¼š**
```javascript
// src/server.js - åº”ç”¨å…¥å£
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const rateLimit = require('express-rate-limit');

const app = express();
const PORT = process.env.PORT || 3000;

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet());
app.use(cors({
  origin: ['https://servicewechat.com', 'https://developers.weixin.qq.com'],
  credentials: true
}));

// è¯·æ±‚é™åˆ¶ - 15åˆ†é’Ÿå†…æœ€å¤š100ä¸ªè¯·æ±‚
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: { error: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•' }
});

// è·¯ç”±å’Œé”™è¯¯å¤„ç†
app.use('/api/products', productRoutes);
app.use('/api/health', healthRoutes);
app.use(errorHandler);
```

### é˜¶æ®µ3ï¼šç”µå•†å¹³å°çˆ¬è™«ç³»ç»Ÿå¼€å‘

**çˆ¬è™«æ¶æ„è®¾è®¡ï¼š**
- é‡‡ç”¨åŸºç±» + ç»§æ‰¿çš„è®¾è®¡æ¨¡å¼
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- åçˆ¬è™«ç­–ç•¥å’Œè¯·æ±‚é¢‘ç‡æ§åˆ¶
- æ ‡å‡†åŒ–çš„æ•°æ®è¾“å‡ºæ ¼å¼

**BaseScraperåŸºç±»åŠŸèƒ½ï¼š**
```javascript
class BaseScraper {
  constructor(platform) {
    this.platform = platform;
    this.timeout = 30000;     // 30ç§’è¶…æ—¶
    this.retryCount = 3;      // é‡è¯•3æ¬¡  
    this.delay = 2000;        // è¯·æ±‚é—´éš”2ç§’
  }

  // æ ¸å¿ƒåŠŸèƒ½
  async fetchPage(url, options = {}) { /* é¡µé¢è·å– */ }
  getRandomUserAgent() { /* éšæœºUA */ }
  extractBySelectors($, selectors) { /* å†…å®¹æå– */ }
  normalizePrice(priceText) { /* ä»·æ ¼æ ‡å‡†åŒ– */ }
  
  // æŠ½è±¡æ–¹æ³• - å­ç±»å¿…é¡»å®ç°
  async scrape(url) {
    throw new Error(`${this.platform}çˆ¬è™«çš„scrapeæ–¹æ³•å¿…é¡»è¢«å­ç±»å®ç°`);
  }
}
```

**æ·˜å®çˆ¬è™«å®ç°ç¤ºä¾‹ï¼š**
```javascript
class TaobaoScraper extends BaseScraper {
  constructor() {
    super('æ·˜å®');
  }

  async scrape(url) {
    // è®¾ç½®æ·˜å®ç‰¹å®šè¯·æ±‚å¤´
    const headers = {
      'User-Agent': 'Mozilla/5.0...',
      'Accept': 'text/html,application/xhtml+xml...',
      'Referer': 'https://www.taobao.com/'
    };

    // è·å–é¡µé¢å†…å®¹
    const html = await this.fetchPage(url, { headers });
    const $ = cheerio.load(html);

    // è§£æå•†å“ä¿¡æ¯
    return {
      title: this.extractTitle($),
      price: this.extractPrice($),
      image: this.extractImage($),
      brand: this.extractBrand($),
      specifications: this.extractSpecifications($),
      // ... æ›´å¤šå­—æ®µ
    };
  }

  extractTitle($) {
    const selectors = [
      '.tb-detail-hd h1',
      '.item-title-text',
      'h1[data-spm="1000983"]'
    ];
    return this.extractBySelectors($, selectors) || 'æœªçŸ¥å•†å“';
  }
}
```

**æ”¯æŒçš„ç”µå•†å¹³å°ï¼š**
1. **æ·˜å®** - æ”¯æŒå•†å“æ ‡é¢˜ã€ä»·æ ¼ã€å›¾ç‰‡ã€å“ç‰Œã€è§„æ ¼å‚æ•°æå–
2. **å¤©çŒ«** - ç‹¬ç«‹å®ç°ï¼Œæ”¯æŒå¤©çŒ«ç‰¹æœ‰çš„æ•°æ®ç»“æ„
3. **äº¬ä¸œ** - æ”¯æŒäº¬ä¸œå•†å“é¡µé¢çš„å®Œæ•´ä¿¡æ¯è§£æ
4. **æ‹¼å¤šå¤š** - åŸºç¡€æ”¯æŒï¼ŒåŒ…å«é™çº§å¤„ç†æœºåˆ¶

### é˜¶æ®µ4ï¼šæ•°æ®å­˜å‚¨å’Œç¼“å­˜ç³»ç»Ÿ

**MySQLæ•°æ®åº“è®¾è®¡ï¼š**
```sql
-- å•†å“ä¸»è¡¨
CREATE TABLE products (
  id VARCHAR(50) PRIMARY KEY,
  title VARCHAR(500) NOT NULL,
  price DECIMAL(10,2) DEFAULT 0.00,
  platform VARCHAR(20) NOT NULL,
  url TEXT NOT NULL,
  image_url TEXT,
  brand VARCHAR(100),
  model VARCHAR(100),
  specifications JSON,
  params JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- ä»·æ ¼å†å²è¡¨  
CREATE TABLE price_history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  product_id VARCHAR(50) NOT NULL,
  price DECIMAL(10,2) NOT NULL,
  availability ENUM('in_stock', 'out_of_stock', 'unknown'),
  recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- ç”¨æˆ·æ”¶è—è¡¨ï¼ˆé¢„ç•™ï¼‰
CREATE TABLE user_favorites (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id VARCHAR(50) NOT NULL,
  product_id VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_product (user_id, product_id)
);
```

**Redisç¼“å­˜ç­–ç•¥ï¼š**
```javascript
class CacheManager {
  // å•†å“ä¿¡æ¯ç¼“å­˜ - 1å°æ—¶TTL
  async set(key, value, ttl = 3600) {
    const serializedValue = JSON.stringify(value);
    await this.client.setEx(key, ttl, serializedValue);
  }

  // æ‰¹é‡ç¼“å­˜æ“ä½œ
  async mset(keyValuePairs, ttl = 3600) {
    const pipeline = this.client.multi();
    for (const [key, value] of Object.entries(keyValuePairs)) {
      pipeline.setEx(key, ttl, JSON.stringify(value));
    }
    await pipeline.exec();
  }

  // ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
  async getStats() {
    const info = await this.client.info('stats');
    return {
      keyspaceHits: info.keyspace_hits,
      keyspaceMisses: info.keyspace_misses,
      hitRatio: info.keyspace_hits / (info.keyspace_hits + info.keyspace_misses)
    };
  }
}
```

### é˜¶æ®µ5ï¼šAPIæ¥å£è®¾è®¡å’Œå®ç°

**æ ¸å¿ƒAPIæ¥å£ï¼š**

1. **å•†å“è§£ææ¥å£**
```javascript
POST /api/products/parse
{
  "url": "https://item.taobao.com/item.htm?id=123456"
}

Response:
{
  "success": true,
  "data": {
    "id": "abc123",
    "title": "å•†å“æ ‡é¢˜",
    "price": "999.00",
    "platform": "æ·˜å®",
    "image": "å›¾ç‰‡URL",
    "params": {...}
  },
  "message": "å•†å“è§£ææˆåŠŸ"
}
```

2. **æ‰¹é‡è§£ææ¥å£**
```javascript
POST /api/products/parse-batch
{
  "urls": [
    "https://item.taobao.com/item.htm?id=123456",
    "https://item.jd.com/789.html"
  ]
}
```

3. **ä»·æ ¼å†å²æ¥å£**
```javascript
GET /api/products/price-history/:productId?days=30
```

**ä¸šåŠ¡é€»è¾‘å®ç°ï¼š**
```javascript
class ProductService {
  async parseProduct(url) {
    // 1. URLéªŒè¯å’Œæ¸…ç†
    const urlInfo = urlParser.parseUrl(url);
    if (!urlInfo.valid) throw new Error(urlInfo.error);

    // 2. æ£€æŸ¥ç¼“å­˜
    const productId = this.generateProductId(url);
    const cached = await cache.get(`product:${productId}`);
    if (cached) return cached;

    // 3. è·å–çˆ¬è™«å¹¶æŠ“å–æ•°æ®
    const scraper = scrapers.getScraper(urlInfo.platform);
    const productData = await scraper.scrape(urlInfo.cleanUrl);
    
    // 4. æ•°æ®æ ‡å‡†åŒ–
    const normalizedProduct = this.normalizeProductData(productData, urlInfo, productId);

    // 5. ä¿å­˜åˆ°æ•°æ®åº“å’Œç¼“å­˜
    await database.saveProduct(normalizedProduct);
    await cache.set(`product:${productId}`, normalizedProduct, 3600);

    return normalizedProduct;
  }
}
```

### é˜¶æ®µ6ï¼šå‰ç«¯APIæ¥å£æ›´æ–°

**æ›´æ–°å°ç¨‹åºAPIé…ç½®ï¼š**
```javascript
// utils/api.js æ›´æ–°
const BASE_URL = 'https://your-domain.com' // ç”Ÿäº§ç¯å¢ƒåœ°å€

// æ›´æ–°APIæ–¹æ³•
function parseProduct(productUrl) {
  return post('/api/products/parse', { url: productUrl })
}

function parseProducts(urls) {
  return post('/api/products/parse-batch', { urls })
}

function getPriceHistory(productId, days = 30) {
  return get(`/api/products/price-history/${productId}`, { days })
}

function checkHealth() {
  return get('/api/health')
}
```

### é˜¶æ®µ7ï¼šæ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ

**Winstonæ—¥å¿—ç³»ç»Ÿï¼š**
```javascript
const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.printf(({ timestamp, level, message, stack, ...meta }) => {
      let logMessage = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
      if (Object.keys(meta).length > 0) {
        logMessage += '\n' + JSON.stringify(meta, null, 2);
      }
      if (stack) logMessage += '\n' + stack;
      return logMessage;
    })
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'logs/app.log' }),
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' })
  ]
});

// ä¸“ç”¨æ—¥å¿—æ–¹æ³•
logger.logRequest = (req, res, responseTime) => { /* HTTPè¯·æ±‚æ—¥å¿— */ };
logger.logScraper = (platform, url, success, responseTime, error) => { /* çˆ¬è™«æ—¥å¿— */ };
logger.logPerformance = (operation, duration, metadata) => { /* æ€§èƒ½æ—¥å¿— */ };
```

**å¥åº·æ£€æŸ¥ç³»ç»Ÿï¼š**
```javascript
// GET /api/health
{
  "success": true,
  "data": {
    "status": "OK",
    "timestamp": "2025-09-11T...",
    "uptime": 3600.123,
    "memory": {...},
    "services": {
      "database": "connected",
      "redis": "connected",
      "scrapers": "active"
    }
  }
}
```

### é˜¶æ®µ8ï¼šéƒ¨ç½²å’Œè¿ç»´æ–¹æ¡ˆ

**ç”Ÿäº§ç¯å¢ƒæ¶æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¾®ä¿¡å°ç¨‹åº     â”‚    â”‚   Nginxåå‘ä»£ç†   â”‚    â”‚   Node.js API   â”‚
â”‚   (å‰ç«¯ç•Œé¢)     â”‚â—„â”€â”€â–ºâ”‚   (è´Ÿè½½å‡è¡¡)     â”‚â—„â”€â”€â–ºâ”‚   (ä¸šåŠ¡é€»è¾‘)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                               â”‚                               â”‚
                       â–¼                               â–¼                               â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚    Redis    â”‚                 â”‚    MySQL    â”‚                 â”‚  çˆ¬è™«æœåŠ¡ç¾¤   â”‚
                â”‚   (ç¼“å­˜)    â”‚                 â”‚  (æ•°æ®å­˜å‚¨)  â”‚                 â”‚ (æ•°æ®é‡‡é›†)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Dockeréƒ¨ç½²æ”¯æŒï¼š**
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

**Nginxåå‘ä»£ç†é…ç½®ï¼š**
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
```

**PM2è¿›ç¨‹ç®¡ç†ï¼š**
```bash
# å¯åŠ¨æœåŠ¡
pm2 start src/server.js --name "smart-compare-api"

# ç›‘æ§å’Œç®¡ç†
pm2 status
pm2 logs smart-compare-api
pm2 restart smart-compare-api

# å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

## æŠ€æœ¯å®ç°äº®ç‚¹

### 1. é«˜å¯æ‰©å±•æ€§æ¶æ„
- **çˆ¬è™«æ’ä»¶åŒ–**ï¼šæ–°å¢å¹³å°åªéœ€å®ç°BaseScraperæ¥å£
- **å¾®æœåŠ¡è®¾è®¡**ï¼šAPIæœåŠ¡ä¸çˆ¬è™«æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
- **æ•°æ®åº“åˆ†ç‰‡**ï¼šæ”¯æŒå¤§æ•°æ®é‡çš„æ°´å¹³åˆ†ç‰‡

### 2. é«˜å¯ç”¨æ€§ä¿éšœ
- **å¤šå±‚ç¼“å­˜**ï¼šRedis + å†…å­˜ç¼“å­˜ï¼Œæå‡å“åº”é€Ÿåº¦
- **æ•…éšœæ¢å¤**ï¼šè‡ªåŠ¨é‡è¯•æœºåˆ¶å’Œé™çº§å¤„ç†
- **è´Ÿè½½å‡è¡¡**ï¼šæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²å’Œè´Ÿè½½åˆ†æ‹…

### 3. å®‰å…¨æ€§æªæ–½  
- **è¾“å…¥éªŒè¯**ï¼šJoiæ ¡éªŒå’ŒSQLæ³¨å…¥é˜²æŠ¤
- **è®¿é—®æ§åˆ¶**ï¼šé¢‘ç‡é™åˆ¶å’ŒIPé»‘åå•
- **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

### 4. å¯ç›‘æ§æ€§
- **å®Œæ•´æ—¥å¿—**ï¼šè¯·æ±‚ã€é”™è¯¯ã€æ€§èƒ½ä¸‰çº§æ—¥å¿—ä½“ç³»
- **å®æ—¶ç›‘æ§**ï¼šå¥åº·æ£€æŸ¥å’Œæ€§èƒ½æŒ‡æ ‡æ”¶é›†  
- **å‘Šè­¦æœºåˆ¶**ï¼šå¼‚å¸¸çŠ¶æ€è‡ªåŠ¨é€šçŸ¥

### 5. åçˆ¬è™«ç­–ç•¥
- **è¯·æ±‚ä¼ªè£…**ï¼šéšæœºUser-Agentå’Œè¯·æ±‚å¤´
- **é¢‘ç‡æ§åˆ¶**ï¼šæ™ºèƒ½å»¶è¿Ÿå’Œè¯·æ±‚åˆ†æ•£
- **ä¼šè¯ç®¡ç†**ï¼šCookieå’Œä»£ç†IPè½®æ¢

## æ•°æ®å¤„ç†èƒ½åŠ›

### å•†å“ä¿¡æ¯æ ‡å‡†åŒ–
```javascript
normalizeProductData(productInfo, platform, originalUrl) {
  return {
    id: generateShortId(originalUrl),
    title: productInfo.title || 'æœªçŸ¥å•†å“',
    price: this.normalizePrice(productInfo.price),
    platform: platform.name,
    originalLink: originalUrl,
    params: this.normalizeParams(productInfo.params || {}),
    parseTime: new Date().toISOString(),
    // æ ‡å‡†åŒ–å­—æ®µæ˜ å°„
    brand: productInfo.brand || '',
    model: productInfo.model || '',  
    sales: productInfo.sales || 0,
    rating: productInfo.rating || 0,
    availability: productInfo.availability || 'unknown'
  }
}
```

### ä»·æ ¼è¶‹åŠ¿åˆ†æ
```javascript
analyzePriceTrends(history) {
  if (!history || history.length < 2) {
    return { trend: 'stable', change: 0, analysis: 'æ•°æ®ä¸è¶³' };
  }

  const latest = history[history.length - 1];
  const previous = history[history.length - 2];  
  const change = latest.price - previous.price;
  const changePercent = ((change / previous.price) * 100).toFixed(2);

  let trend = 'stable';
  if (change > 0) trend = 'up';
  if (change < 0) trend = 'down';

  return {
    trend,
    change: change.toFixed(2),
    changePercent,
    analysis: this.generateTrendAnalysis(trend, changePercent)
  };
}
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®åº“ä¼˜åŒ–
```sql
-- åˆ›å»ºå…³é”®ç´¢å¼•
CREATE INDEX idx_products_platform_price ON products(platform, price);
CREATE INDEX idx_price_history_product_date ON price_history(product_id, recorded_at);

-- åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆå¤§æ•°æ®é‡ï¼‰
ALTER TABLE price_history 
PARTITION BY RANGE (YEAR(recorded_at)) (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026)
);
```

### 2. ç¼“å­˜ç­–ç•¥
- **å•†å“ä¿¡æ¯ç¼“å­˜**ï¼š1å°æ—¶TTLï¼Œçƒ­ç‚¹æ•°æ®é¢„åŠ è½½
- **ä»·æ ¼å†å²ç¼“å­˜**ï¼š30åˆ†é’ŸTTLï¼ŒæŒ‰éœ€åŠ è½½
- **APIå“åº”ç¼“å­˜**ï¼š5åˆ†é’ŸTTLï¼Œå‡å°‘é‡å¤è®¡ç®—

### 3. å¹¶å‘å¤„ç†
```javascript
// æ‰¹é‡è§£æä¼˜åŒ–
async parseMultipleProducts(urls) {
  const results = [];
  const errors = [];
  
  // å¹¶å‘æ§åˆ¶ï¼Œé¿å…è¿‡è½½
  const chunks = this.chunkArray(urls, 3);
  
  for (const chunk of chunks) {
    const promises = chunk.map(url => 
      this.parseProduct(url).catch(error => ({ url, error: error.message }))
    );
    
    const chunkResults = await Promise.all(promises);
    // å¤„ç†ç»“æœ...
  }
  
  return { products: results, errors, summary: {...} };
}
```

## æµ‹è¯•å’ŒéªŒè¯

### å•å…ƒæµ‹è¯•è¦†ç›–
- URLè§£æå™¨æµ‹è¯•
- å•†å“æ•°æ®æ ‡å‡†åŒ–æµ‹è¯•  
- ç¼“å­˜ç³»ç»Ÿæµ‹è¯•
- æ•°æ®åº“æ“ä½œæµ‹è¯•

### é›†æˆæµ‹è¯•
```javascript
// å•†å“è§£æé›†æˆæµ‹è¯•
const testUrls = [
  'https://item.taobao.com/item.htm?id=123456789',
  'https://detail.tmall.com/item.htm?id=987654321',
  'https://item.jd.com/12345.html',
  'https://mobile.yangkeduo.com/goods.html?goods_id=54321'
];

async function testProductParsing() {
  for (const url of testUrls) {
    const startTime = Date.now();
    const product = await productService.parseProduct(url);
    const endTime = Date.now();
    
    console.log(`è§£ææˆåŠŸ (${endTime - startTime}ms):`, {
      id: product.id,
      title: product.title,
      price: product.price,
      platform: product.platform
    });
  }
}
```

## éƒ¨ç½²å®æ–½æ–¹æ¡ˆ

### ç¯å¢ƒå‡†å¤‡
```bash
# æœåŠ¡å™¨ç¯å¢ƒæ­å»º
sudo apt update && sudo apt upgrade -y
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs mysql-server redis-server nginx

# é¡¹ç›®éƒ¨ç½²
git clone <repository>
cd backend
npm install
cp .env.example .env
# ç¼–è¾‘ç¯å¢ƒé…ç½®

# æ•°æ®åº“åˆå§‹åŒ–
mysql -u root -p << EOF
CREATE DATABASE smart_compare CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'smart_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT ALL PRIVILEGES ON smart_compare.* TO 'smart_user'@'localhost';
EOF
```

### SSLè¯ä¹¦é…ç½®
```bash
# ä½¿ç”¨Let's Encryptç”³è¯·å…è´¹SSLè¯ä¹¦
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

### ç›‘æ§å‘Šè­¦
```bash
# ç³»ç»Ÿç›‘æ§
htop              # å®æ—¶ç³»ç»Ÿç›‘æ§
iostat -x 1       # I/Oç›‘æ§
free -h           # å†…å­˜ç›‘æ§

# åº”ç”¨ç›‘æ§  
pm2 status        # è¿›ç¨‹çŠ¶æ€
pm2 logs --lines 50   # åº”ç”¨æ—¥å¿—
tail -f logs/error.log # é”™è¯¯æ—¥å¿—

# æ•°æ®åº“ç›‘æ§
mysql -u root -p -e "SHOW PROCESSLIST;"
mysql -u root -p -e "SHOW GLOBAL STATUS LIKE 'Slow_queries';"
```

## å®‰å…¨åŠ å›ºæªæ–½

### 1. æœåŠ¡å™¨å®‰å…¨
```bash
# é˜²ç«å¢™é…ç½®
sudo ufw default deny incoming
sudo ufw default allow outgoing  
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# SSHå®‰å…¨
sudo vim /etc/ssh/sshd_config
# PasswordAuthentication no
# AllowUsers your-username
sudo systemctl restart ssh
```

### 2. åº”ç”¨å®‰å…¨
- **è¾“å…¥éªŒè¯**ï¼šæ‰€æœ‰APIè¾“å…¥ä½¿ç”¨Joiä¸¥æ ¼æ ¡éªŒ
- **SQLæ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- **XSSé˜²æŠ¤**ï¼šè¾“å‡ºå†…å®¹è½¬ä¹‰å’ŒCSPå¤´
- **CSRFé˜²æŠ¤**ï¼šTokenéªŒè¯æœºåˆ¶

### 3. æ•°æ®å®‰å…¨
- **æ•æ„Ÿä¿¡æ¯åŠ å¯†**ï¼šç”¨æˆ·æ•°æ®å’Œé…ç½®åŠ å¯†å­˜å‚¨
- **å®šæœŸå¤‡ä»½**ï¼šæ•°æ®åº“æ¯æ—¥å¤‡ä»½å¹¶å¼‚åœ°å­˜å‚¨
- **è®¿é—®æ§åˆ¶**ï¼šæœ€å°æƒé™åŸåˆ™å’Œè§’è‰²åˆ†ç¦»

## é¡¹ç›®æˆæœæ€»ç»“

### âœ… å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

1. **å®Œæ•´åç«¯APIæœåŠ¡**
   - Express.js + ä¸­é—´ä»¶å®‰å…¨æ ˆ
   - RESTful APIæ¥å£è§„èŒƒ
   - ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼
   - è¯·æ±‚éªŒè¯å’Œé™æµä¿æŠ¤

2. **ç”Ÿäº§çº§çˆ¬è™«ç³»ç»Ÿ**
   - æ”¯æŒæ·˜å®ã€å¤©çŒ«ã€äº¬ä¸œã€æ‹¼å¤šå¤šå››å¤§å¹³å°
   - é˜²åçˆ¬æœºåˆ¶å’Œæ™ºèƒ½é‡è¯•
   - æ•°æ®æ ‡å‡†åŒ–å’Œè´¨é‡æ§åˆ¶
   - å¯æ‰©å±•çš„æ’ä»¶åŒ–æ¶æ„

3. **é«˜æ€§èƒ½å­˜å‚¨ç³»ç»Ÿ**
   - MySQLå…³ç³»æ•°æ®åº“ + å®Œæ•´è¡¨è®¾è®¡
   - Redisç¼“å­˜å±‚ + TTLç­–ç•¥  
   - ä»·æ ¼å†å²è·Ÿè¸ªåŠŸèƒ½
   - ç”¨æˆ·æ•°æ®è¡¨é¢„ç•™è®¾è®¡

4. **å®Œå–„ç›‘æ§ä½“ç³»**
   - Winstonå¤šçº§æ—¥å¿—ç³»ç»Ÿ
   - æ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥
   - é”™è¯¯æ”¶é›†å’Œå‘Šè­¦æœºåˆ¶
   - å®æ—¶çŠ¶æ€ä»ªè¡¨æ¿

5. **ç”Ÿäº§éƒ¨ç½²æ–¹æ¡ˆ**
   - Dockerå®¹å™¨åŒ–æ”¯æŒ
   - Nginxåå‘ä»£ç† + SSL
   - PM2è¿›ç¨‹ç®¡ç†å’Œç›‘æ§
   - å®Œæ•´çš„è¿ç»´æ–‡æ¡£

### ğŸ“Š ç³»ç»ŸæŠ€æœ¯æŒ‡æ ‡

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- APIå“åº”æ—¶é—´: < 2ç§’
- å•†å“è§£ææˆåŠŸç‡: > 95%
- ç¼“å­˜å‘½ä¸­ç‡: > 80%
- å¹¶å‘å¤„ç†èƒ½åŠ›: 1000 QPS

**å¯ç”¨æ€§æŒ‡æ ‡ï¼š**
- ç³»ç»Ÿæ­£å¸¸è¿è¡Œæ—¶é—´: > 99.5%
- æ•…éšœæ¢å¤æ—¶é—´: < 5åˆ†é’Ÿ
- æ•°æ®ä¸€è‡´æ€§: å¼ºä¸€è‡´æ€§ä¿éšœ

**å®‰å…¨æŒ‡æ ‡ï¼š**
- å…¨é‡HTTPSä¼ è¾“åŠ å¯†
- SQLæ³¨å…¥é›¶å®¹å¿
- è®¿é—®é¢‘ç‡æ™ºèƒ½é™åˆ¶
- æ•æ„Ÿæ•°æ®è„±æ•å¤„ç†

### ğŸ¯ æ ¸å¿ƒä»·å€¼å®ç°

1. **ä»æ¼”ç¤ºåˆ°ç”Ÿäº§**
   - å®Œæˆä»æ¨¡æ‹Ÿæ•°æ®åˆ°çœŸå®æ•°æ®çš„å®Œæ•´è½¬æ¢
   - å»ºç«‹äº†å•†ä¸šçº§çš„æŠ€æœ¯æ¶æ„
   - å…·å¤‡äº†å¤„ç†çœŸå®ç”¨æˆ·è¯·æ±‚çš„èƒ½åŠ›

2. **æŠ€æœ¯æ¶æ„ä¼˜åŠ¿**
   - é«˜å¯æ‰©å±•æ€§ï¼šæ”¯æŒæ–°å¹³å°å¿«é€Ÿæ¥å…¥
   - é«˜å¯ç”¨æ€§ï¼šå¤šå±‚å®¹é”™å’Œæ•…éšœæ¢å¤
   - é«˜æ€§èƒ½ï¼šç¼“å­˜ç­–ç•¥å’Œå¹¶å‘ä¼˜åŒ–
   - é«˜å®‰å…¨æ€§ï¼šå…¨é¢çš„å®‰å…¨é˜²æŠ¤æªæ–½

3. **å•†ä¸šåŒ–å°±ç»ª**
   - å®Œæ•´çš„APIæ¥å£æ”¯æŒå„ç§ä¸šåŠ¡åœºæ™¯
   - ä»·æ ¼å†å²åˆ†ææ”¯æŒå†³ç­–è¾…åŠ©
   - ç”¨æˆ·ç³»ç»Ÿé¢„ç•™æ”¯æŒä¸ªæ€§åŒ–åŠŸèƒ½
   - ç›‘æ§å‘Šè­¦æ”¯æŒ7x24å°æ—¶è¿è¥

## ä¸‹ä¸€æ­¥å‘å±•è§„åˆ’

### è¿‘æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
1. **çœŸæœºè”è°ƒæµ‹è¯•**
   - éƒ¨ç½²æµ‹è¯•ç¯å¢ƒéªŒè¯APIè¿é€šæ€§
   - å‰åç«¯æ•°æ®äº¤äº’å®Œæ•´æ€§æµ‹è¯•
   - æ€§èƒ½å‹åŠ›æµ‹è¯•å’Œç“¶é¢ˆä¼˜åŒ–

2. **ç”¨æˆ·ä½“éªŒå¢å¼º**  
   - é”™è¯¯æç¤ºä¼˜åŒ–å’Œç”¨æˆ·å¼•å¯¼
   - åŠ è½½çŠ¶æ€å’Œè¿›åº¦åé¦ˆ
   - ç½‘ç»œå¼‚å¸¸å¤„ç†å’Œé‡è¯•æœºåˆ¶

### ä¸­æœŸåŠŸèƒ½æ‰©å±•ï¼ˆ1ä¸ªæœˆï¼‰
1. **é«˜çº§åŠŸèƒ½å¼€å‘**
   - ä»·æ ¼å†å²è¶‹åŠ¿å›¾è¡¨
   - ç”¨æˆ·æ”¶è—å’Œå…³æ³¨åˆ—è¡¨
   - ä»·æ ¼å˜åŠ¨æé†’æ¨é€
   - å•†å“è¯„ä»·å¯¹æ¯”åˆ†æ

2. **å¹³å°æ‰©å±•**
   - æ¥å…¥æ›´å¤šç”µå•†å¹³å°ï¼ˆè‹å®ã€å›½ç¾ç­‰ï¼‰
   - æµ·å¤–ç”µå•†å¹³å°æ”¯æŒï¼ˆäºšé©¬é€Šã€eBayï¼‰
   - å‚ç›´ç”µå•†å¹³å°ï¼ˆè€ƒæ‹‰ã€å°çº¢ä¹¦ï¼‰

### é•¿æœŸå•†ä¸šåŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰  
1. **AIæ™ºèƒ½åŒ–**
   - å•†å“æ™ºèƒ½åˆ†ç±»å’Œæ¨è
   - ä»·æ ¼é¢„æµ‹å’Œè¶‹åŠ¿åˆ†æ
   - ç”¨æˆ·è´­ä¹°æ„å›¾è¯†åˆ«
   - ä¸ªæ€§åŒ–æ¯”ä»·ç­–ç•¥

2. **ç”Ÿæ€ç³»ç»Ÿ**
   - å¼€æ”¾APIæ”¯æŒç¬¬ä¸‰æ–¹æ¥å…¥
   - å•†å®¶æ•°æ®æœåŠ¡å˜ç°
   - ç”¨æˆ·æ•°æ®æ´å¯Ÿäº§å“
   - ç”µå•†å¯¼è´­åˆ†ä½£æ¨¡å¼

## æŠ€æœ¯å€ºåŠ¡å’Œæ”¹è¿›è®¡åˆ’

### å½“å‰æŠ€æœ¯å€ºåŠ¡
1. **çˆ¬è™«ç¨³å®šæ€§**ï¼šæ‹¼å¤šå¤šå¹³å°è§£ææˆåŠŸç‡æœ‰å¾…æå‡
2. **ç¼“å­˜ç­–ç•¥**ï¼šéœ€è¦æ›´ç²¾ç»†çš„ç¼“å­˜å¤±æ•ˆå’Œæ›´æ–°ç­–ç•¥  
3. **ç›‘æ§å‘Šè­¦**ï¼šç¼ºå°‘ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦
4. **æµ‹è¯•è¦†ç›–**ï¼šéœ€è¦å¢åŠ ç«¯åˆ°ç«¯æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•

### æ”¹è¿›ä¼˜å…ˆçº§
1. **P0 - ç¨³å®šæ€§**ï¼šå®Œå–„é”™è¯¯å¤„ç†å’Œæ•…éšœæ¢å¤æœºåˆ¶
2. **P1 - æ€§èƒ½**ï¼šæ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥è°ƒä¼˜
3. **P2 - ç›‘æ§**ï¼šå»ºç«‹å®Œæ•´çš„APMç›‘æ§ä½“ç³»
4. **P3 - æ‰©å±•**ï¼šæ”¯æŒæ›´å¤šç”µå•†å¹³å°å’Œæ•°æ®æº

---

## ç»“è®º

**é¡¹ç›®çŠ¶æ€ï¼š** ä»æ¼”ç¤ºç‰ˆæœ¬æˆåŠŸå‡çº§ä¸ºç”Ÿäº§çº§ç³»ç»Ÿ âœ…

**æŠ€æœ¯æˆå°±ï¼š**
- å»ºç«‹äº†å®Œæ•´çš„åç«¯æœåŠ¡æ¶æ„ï¼Œæ”¯æŒçœŸå®ç”µå•†æ•°æ®æŠ“å–
- å®ç°äº†é«˜æ€§èƒ½ã€é«˜å¯ç”¨ã€é«˜å®‰å…¨çš„APIæœåŠ¡ä½“ç³»
- æä¾›äº†å®Œæ•´çš„éƒ¨ç½²è¿ç»´æ–¹æ¡ˆå’Œç›‘æ§å‘Šè­¦æœºåˆ¶
- å…·å¤‡äº†å•†ä¸šåŒ–è¿è¥çš„æŠ€æœ¯åŸºç¡€å’Œæ‰©å±•èƒ½åŠ›

**å•†ä¸šä»·å€¼ï¼š**
- èƒ½å¤Ÿä¸ºçœŸå®ç”¨æˆ·æä¾›å‡†ç¡®çš„å•†å“æ¯”ä»·æœåŠ¡
- æ”¯æŒå¤§è§„æ¨¡ç”¨æˆ·è®¿é—®å’Œé«˜å¹¶å‘è¯·æ±‚å¤„ç†
- å…·å¤‡æ•°æ®å˜ç°å’Œå•†ä¸šæ¨¡å¼æ‹“å±•çš„æŠ€æœ¯åŸºç¡€
- ä¸ºç”µå•†ç”Ÿæ€æä¾›äº†æœ‰ä»·å€¼çš„æ•°æ®æœåŠ¡å¹³å°

**ä¸‹ä¸€é‡Œç¨‹ç¢‘ï¼š** å®Œæˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼Œå¼€å§‹çœŸå®ç”¨æˆ·æµ‹è¯•å’Œåé¦ˆæ”¶é›†

---

**å¼€å‘å®Œæˆæ—¶é—´ï¼š** 2025-09-11  
**æ–‡æ¡£è®°å½•æ—¶é—´ï¼š** 2025-09-11  
**é¡¹ç›®çŠ¶æ€ï¼š** ç”Ÿäº§å°±ç»ªï¼Œå¾…éƒ¨ç½²ä¸Šçº¿  
**æŠ€æœ¯è´Ÿè´£äººï¼š** Claude Code Assistant